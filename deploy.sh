#!/bin/bash

# Master Deployment Script for Digital Ocean Droplet
# This handles all deployment, initialization, and setup
# Usage: ./deploy.sh

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo "======================================"
echo "ðŸš€ Auto-Ops-AI Complete Deployment"
echo "======================================"

# Export environment variables
export DOCKER_HUB_USERNAME="${DOCKER_HUB_USERNAME:-}"
export DOCKER_HUB_PASSWORD="${DOCKER_HUB_PASSWORD:-}"
export GOOGLE_API_KEY="${GOOGLE_API_KEY:-}"
export DROPLET_IP=$(hostname -I | awk '{print $1}')

if [ -z "$DOCKER_HUB_USERNAME" ]; then
    echo "âŒ Error: DOCKER_HUB_USERNAME not set"
    exit 1
fi

echo "ðŸ“ Droplet IP: $DROPLET_IP"
echo "ðŸ³ Docker Hub User: $DOCKER_HUB_USERNAME"

# Step 1: Ensure tools are installed
echo ""
echo "1ï¸âƒ£  Checking Docker installation..."
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker not found. Installing..."
    curl -fsSL https://get.docker.com -o get-docker.sh
    sudo sh get-docker.sh
    rm get-docker.sh
fi

if ! command -v docker-compose &> /dev/null; then
    echo "âŒ docker-compose not found. Installing..."
    sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose
fi

echo "âœ… Docker tools ready"

# Step 2: Prepare application directory
echo ""
echo "2ï¸âƒ£  Preparing /app directory..."
mkdir -p /app
cd /app

# Step 3: Clone/update repository
echo ""
echo "3ï¸âƒ£  Cloning repository..."
if [ ! -d .git ]; then
    git clone https://github.com/gimhanadeshan/auto-ops-ai.git .
else
    git fetch origin main
    git checkout -f origin/main
fi
echo "âœ… Repository updated"

# Step 4: Create environment files
echo ""
echo "4ï¸âƒ£  Creating environment configuration files..."

# Create backend .env
mkdir -p backend
cat > backend/.env << EOF
# Auto-generated by deploy.sh
LLM_PROVIDER=gemini
EMBEDDING_PROVIDER=gemini
GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
GEMINI_MODEL=models/gemini-2.5-flash
GEMINI_TEMPERATURE=0.9
EMBEDDING_MODEL=models/embedding-001
OPENAI_API_KEY=
OPENAI_MODEL=gpt-4
DATABASE_URL=sqlite:///./data/auto_ops.db
SECRET_KEY=auto-ops-ai-secret-key-change-in-production
ENVIRONMENT=production
EOF
echo "âœ… Backend .env created"

# Create frontend .env
mkdir -p frontend
cat > frontend/.env << EOF
# Auto-generated by deploy.sh
VITE_API_BASE_URL=http://${DROPLET_IP}:8000/api/v1
EOF
echo "âœ… Frontend .env created"

# Step 5: Login to Docker Hub
echo ""
echo "5ï¸âƒ£  Logging in to Docker Hub..."
echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
echo "âœ… Docker Hub login successful"

# Step 6: Pull latest images
echo ""
echo "6ï¸âƒ£  Pulling latest Docker images..."
docker pull $DOCKER_HUB_USERNAME/auto-ops-ai-backend:latest
docker pull $DOCKER_HUB_USERNAME/auto-ops-ai-frontend:latest
echo "âœ… Images pulled successfully"

# Step 7: Stop old containers
echo ""
echo "7ï¸âƒ£  Stopping old containers..."
docker-compose -f docker-compose.deploy.yml down || true
echo "âœ… Old containers stopped"

# Step 8: Start new containers
echo ""
echo "8ï¸âƒ£  Starting new containers..."
docker-compose -f docker-compose.deploy.yml up -d
echo "âœ… Containers started"

# Step 9: Open firewall ports
echo ""
echo "9ï¸âƒ£  Configuring firewall..."
ufw allow 8000/tcp || true
ufw allow 80/tcp || true
ufw allow 443/tcp || true
echo "âœ… Firewall configured"

# Step 10: Wait for services
echo ""
echo "ðŸ”Ÿ Waiting for services to stabilize..."
sleep 20

# Step 11: Initialize database
echo ""
echo "1ï¸âƒ£1ï¸âƒ£ Initializing database..."
docker-compose -f docker-compose.deploy.yml exec -T backend python backend/init_db.py || true
echo "âœ… Database initialized"

# Step 12: Load seed data
echo ""
echo "1ï¸âƒ£2ï¸âƒ£ Loading seed data..."
docker-compose -f docker-compose.deploy.yml exec -T backend python backend/ingestion_script.py || true
echo "âœ… Seed data loaded"

# Step 13: Verify deployment
echo ""
echo "1ï¸âƒ£3ï¸âƒ£ Verifying deployment..."
docker-compose -f docker-compose.deploy.yml ps

# Cleanup
docker logout

echo ""
echo "======================================"
echo "âœ… Deployment Complete!"
echo "======================================"
echo ""
echo "ðŸŒ Access your application:"
echo "   Frontend:  http://$DROPLET_IP"
echo "   Backend:   http://$DROPLET_IP:8000"
echo "   API Docs:  http://$DROPLET_IP:8000/docs"
echo ""
echo "ðŸ“‹ View logs:"
echo "   docker-compose -f docker-compose.deploy.yml logs -f"
echo ""
