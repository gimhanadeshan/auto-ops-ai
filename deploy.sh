#!/bin/bash

# Master Deployment Script for Digital Ocean Droplet
# This handles all deployment, initialization, and setup
# Usage: ./deploy.sh

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo "======================================"
echo "üöÄ Auto-Ops-AI Complete Deployment"
echo "======================================"

# Export environment variables
export DOCKER_HUB_USERNAME="${DOCKER_HUB_USERNAME:-}"
export DOCKER_HUB_PASSWORD="${DOCKER_HUB_PASSWORD:-}"
export GOOGLE_API_KEY="${GOOGLE_API_KEY:-}"
export DROPLET_IP=$(hostname -I | awk '{print $1}')

if [ -z "$DOCKER_HUB_USERNAME" ]; then
    echo "‚ùå Error: DOCKER_HUB_USERNAME not set"
    exit 1
fi

echo "üìç Droplet IP: $DROPLET_IP"
echo "üê≥ Docker Hub User: $DOCKER_HUB_USERNAME"

# Step 1: Ensure tools are installed
echo ""
echo "1Ô∏è‚É£  Checking Docker installation..."
if ! command -v docker &> /dev/null; then
    echo "‚ùå Docker not found. Installing..."
    curl -fsSL https://get.docker.com -o get-docker.sh
    sudo sh get-docker.sh
    rm get-docker.sh
fi

if ! command -v docker-compose &> /dev/null; then
    echo "‚ùå docker-compose not found. Installing..."
    sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose
fi

echo "‚úÖ Docker tools ready"

# Step 2: Prepare application directory
echo ""
echo "2Ô∏è‚É£  Preparing /app directory..."
mkdir -p /app
cd /app

# Step 3: Clone/update repository
echo ""
echo "3Ô∏è‚É£  Cloning repository..."
REBUILD_NEEDED=false

if [ ! -d .git ]; then
    git clone https://github.com/gimhanadeshan/auto-ops-ai.git .
    REBUILD_NEEDED=true
else
    # Check if there are new changes
    git fetch origin main
    LOCAL=$(git rev-parse HEAD)
    REMOTE=$(git rev-parse origin/main)
    
    if [ "$LOCAL" != "$REMOTE" ]; then
        echo "üìù Code changes detected - will rebuild images"
        REBUILD_NEEDED=true
        git checkout -f origin/main
    else
        echo "‚úì Code is up-to-date - using cached images"
        REBUILD_NEEDED=false
    fi
fi
echo "‚úÖ Repository updated"

# Step 4: Create environment files
echo ""
echo "4Ô∏è‚É£  Creating environment configuration files..."

# Create backend .env
mkdir -p backend
cat > backend/.env << EOF
# Auto-generated by deploy.sh
LLM_PROVIDER=gemini
EMBEDDING_PROVIDER=gemini
GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
GEMINI_MODEL=models/gemini-2.5-flash
GEMINI_TEMPERATURE=0.9
EMBEDDING_MODEL=models/embedding-001
OPENAI_API_KEY=
OPENAI_MODEL=gpt-4
DATABASE_URL=sqlite:///./data/auto_ops.db
SECRET_KEY=auto-ops-ai-secret-key-change-in-production
ENVIRONMENT=production
EOF
echo "‚úÖ Backend .env created"

# Create frontend .env
mkdir -p frontend
cat > frontend/.env << EOF
# Auto-generated by deploy.sh
VITE_API_BASE_URL=http://${DROPLET_IP}:8000/api/v1
EOF
echo "‚úÖ Frontend .env created"

# Step 5: Login to Docker Hub
echo ""
echo "5Ô∏è‚É£  Logging in to Docker Hub..."
echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
echo "‚úÖ Docker Hub login successful"

# Step 6: Pull latest images or build if changes detected
echo ""
echo "6Ô∏è‚É£  Processing Docker images..."

if [ "$REBUILD_NEEDED" = true ]; then
    echo "üî® Building new images from source..."
    docker-compose -f docker-compose.deploy.yml build --no-cache
    echo "‚úÖ Images built successfully"
else
    echo "üì¶ Pulling latest pre-built images..."
    docker pull $DOCKER_HUB_USERNAME/auto-ops-ai-backend:latest || echo "‚ö†Ô∏è  Backend image not found - will build from source"
    docker pull $DOCKER_HUB_USERNAME/auto-ops-ai-frontend:latest || echo "‚ö†Ô∏è  Frontend image not found - will build from source"
    echo "‚úÖ Images processed"
fi

# Step 7: Stop old containers
echo ""
echo "7Ô∏è‚É£  Stopping old containers..."
docker-compose -f docker-compose.deploy.yml down || true
echo "‚úÖ Old containers stopped"

# Step 8: Start new containers
echo ""
echo "8Ô∏è‚É£  Starting new containers..."
docker-compose -f docker-compose.deploy.yml up -d
echo "‚úÖ Containers started"

# Step 9: Open firewall ports
echo ""
echo "9Ô∏è‚É£  Configuring firewall..."
ufw allow 8000/tcp || true
ufw allow 80/tcp || true
ufw allow 443/tcp || true
echo "‚úÖ Firewall configured"

# Step 10: Wait for services
echo ""
echo "üîü Waiting for services to stabilize..."
sleep 20

# Step 11: Initialize database (skip if already exists)
echo ""
echo "1Ô∏è‚É£1Ô∏è‚É£ Checking database status..."
DB_PATH="./backend/data/auto_ops.db"

if [ -f "$DB_PATH" ]; then
    echo "‚úÖ Database already exists - skipping initialization"
else
    echo "üîÑ Database not found - initializing..."
    docker-compose -f docker-compose.deploy.yml exec -T backend python backend/init_db.py || true
    echo "‚úÖ Database initialized"
fi

# Step 12: Load seed data (only if database was newly created)
echo ""
echo "1Ô∏è‚É£2Ô∏è‚É£ Checking seed data status..."
# Check if users table has data
USERS_COUNT=$(docker-compose -f docker-compose.deploy.yml exec -T backend python -c "
from app.core.database import SessionLocal
from app.models.user import UserDB
session = SessionLocal()
count = session.query(UserDB).count()
print(count)
" 2>/dev/null || echo "0")

if [ "$USERS_COUNT" -gt 0 ]; then
    echo "‚úÖ Seed data already loaded - skipping ingestion"
else
    echo "üîÑ Loading seed data..."
    docker-compose -f docker-compose.deploy.yml exec -T backend python backend/ingestion_script.py || true
    echo "‚úÖ Seed data loaded"
fi

# Step 13: Verify deployment
echo ""
echo "1Ô∏è‚É£3Ô∏è‚É£ Verifying deployment..."
docker-compose -f docker-compose.deploy.yml ps

# Cleanup
docker logout

echo ""
echo "======================================"
echo "‚úÖ Deployment Complete!"
echo "======================================"
echo ""
echo "üìä Deployment Summary:"
echo "   Code Changes:     $([ "$REBUILD_NEEDED" = true ] && echo "YES - Images rebuilt" || echo "NO - Used cached images")"
echo "   Database:         $([ -f "$DB_PATH" ] && echo "Existing (preserved)" || echo "New (initialized)")"
echo "   Seed Data:        $([ "$USERS_COUNT" -gt 0 ] && echo "Already loaded" || echo "Newly loaded")"
echo ""
echo "üåê Access your application:"
echo "   Frontend:  http://$DROPLET_IP"
echo "   Backend:   http://$DROPLET_IP:8000"
echo "   API Docs:  http://$DROPLET_IP:8000/docs"
echo ""
echo "üìã View logs:"
echo "   docker-compose -f docker-compose.deploy.yml logs -f"
echo ""
